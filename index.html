<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Sakura Season ‚Äì Catch the Petals</title>
  <style>
    :root { --pad: 16px; --ink:#111; --muted: rgba(0,0,0,.65); }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top, #ffe8f2, #fff);
      color: var(--ink);
      min-height: 100vh;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .card{
      width:min(560px, calc(100vw - 24px));
      background: rgba(255,255,255,0.90);
      border:1px solid rgba(0,0,0,0.08);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      overflow:hidden;
    }

    header{ padding: 18px 18px 10px; }
    h1{ font-size: 18px; margin: 0 0 6px; }
    p{ margin:0; opacity:.75; line-height:1.35; font-size:14px; }

    .rules{
      margin-top:10px;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.35;
    }
    .rules b{ color: var(--ink); }

    .stageWrap{ padding: 0 18px 18px; }

    #stage{
      position: relative;
      width: 100%;
      aspect-ratio: 9 / 14;
      background: linear-gradient(180deg, rgba(255,210,230,0.55), rgba(255,255,255,0.95));
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.06);
      touch-action: manipulation;
    }

    .hud{
      position:absolute; top:10px; left:10px; right:10px;
      display:flex; justify-content:space-between; gap:10px;
      pointer-events:none;
    }

    .pill{
      padding: 8px 10px;
      background: rgba(255,255,255,0.85);
      border: 1px solid rgba(0,0,0,0.07);
      border-radius: 999px;
      font-weight: 700;
      font-size: 13px;
      backdrop-filter: blur(6px);
    }

    .center{
      position:absolute; inset:0;
      display:grid;
      place-items:center;
      padding:18px;
      text-align:center;
    }

    .btn{
      appearance:none;
      border:0;
      border-radius:14px;
      padding:12px 16px;
      font-weight:800;
      font-size:15px;
      background:#111;
      color:#fff;
      width:min(320px, 100%);
      cursor:pointer;
    }
    .btn.secondary{
      background:#fff;
      color:#111;
      border:1px solid rgba(0,0,0,0.12);
      font-weight:800;
    }

    .stack{ display:grid; gap:10px; justify-items:center; }
    .small{ font-size: 12px; opacity:.72; line-height: 1.35; }
    .small a{ color:#111; }

    .petal{
      position:absolute;
      width: 36px; height: 36px;
      transform: translate(-50%,-50%) rotate(0deg);
      border-radius: 12px 18px 12px 18px;
      background: radial-gradient(circle at 30% 30%, #fff, #ffb4d1 55%, #ff8ab8);
      box-shadow: 0 8px 16px rgba(255, 110, 170, 0.18);
      border: 1px solid rgba(0,0,0,0.05);
      user-select:none;
    }
    .petal:before{
      content:"";
      position:absolute;
      inset:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,0.55);
      filter: blur(0.2px);
    }

    .toast{
      position:absolute; bottom:10px; left:10px; right:10px;
      display:grid; place-items:center;
      pointer-events:none;
      font-size:12px;
      opacity:.85;
      min-height: 18px;
    }

    .code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      padding: 10px 12px;
      background: rgba(0,0,0,0.06);
      border-radius: 10px;
      display:inline-block;
      margin-top: 8px;
      letter-spacing: 0.5px;
      font-weight: 800;
    }

    .notice{
      background: rgba(0,0,0,0.06);
      border: 1px solid rgba(0,0,0,0.08);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      color: rgba(0,0,0,0.75);
      line-height: 1.35;
      max-width: 420px;
    }
  </style>
</head>

<body>
  <div class="card">
    <header>
      <h1>üå∏ Sakura Season ‚Äì Catch the Petals</h1>
      <p>Tap as many petals as you can in <b>15 seconds</b>.</p>

      <div class="rules">
        Prizes:
        <b>15‚Äì30</b> petals = <b>Miso Soup</b> ‚Ä¢
        <b>31‚Äì50</b> petals = <b>Miso Soup + Soft Drink</b> ‚Ä¢
        <b>51+</b> petals = <b>A Meal</b>
      </div>
      <div class="rules">
        One play per day (per device). One prize at a time.
      </div>
    </header>

    <div class="stageWrap">
      <div id="stage" aria-label="Game area">
        <div class="hud">
          <div class="pill">‚è± <span id="time">15.0</span>s</div>
          <div class="pill">üå∏ Petals: <span id="score">0</span></div>
        </div>

        <div class="center" id="overlay">
          <div class="stack" id="overlayInner">
            <div style="font-weight:900;font-size:18px;">Ready?</div>
            <div class="small">
              Tap petals to score. Hit the prize ranges above to win a voucher.
            </div>

            <button class="btn" id="startBtn">Start</button>
            <button class="btn secondary" id="howBtn">How it works</button>

            <div class="small" id="limitMsg" style="display:none;"></div>
            <div class="small" id="prizeBlockMsg" style="display:none;"></div>

            <div class="notice">
              Demo mode: limits are stored on this device/browser. For the official campaign we‚Äôll enable server validation.
            </div>
          </div>
        </div>

        <div class="toast" id="toast"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ===== CONFIG =====
  const GAME_SECONDS = 15;
  const SPAWN_PER_SEC = 2.4;
  const FALL_SPEED_MIN = 130;
  const FALL_SPEED_MAX = 280;
  const DAILY_PLAY_LIMIT = 1;

  // Prize ranges (Option B)
  function prizeForScore(score) {
    if (score >= 51) return { tier: 3, label: "A Meal" };
    if (score >= 31) return { tier: 2, label: "Miso Soup + Soft Drink" };
    if (score >= 15) return { tier: 1, label: "Miso Soup" };
    return null;
  }

  // ===== ELEMENTS =====
  const stage = document.getElementById("stage");
  const overlay = document.getElementById("overlay");
  const startBtn = document.getElementById("startBtn");
  const howBtn = document.getElementById("howBtn");
  const scoreEl = document.getElementById("score");
  const timeEl = document.getElementById("time");
  const toastEl = document.getElementById("toast");
  const limitMsg = document.getElementById("limitMsg");
  const prizeBlockMsg = document.getElementById("prizeBlockMsg");

  // ===== STATE =====
  let running = false;
  let score = 0;
  let tLeft = GAME_SECONDS;
  let lastTs = null;
  let spawnAcc = 0;
  let petals = [];
  let rafId = null;

  // ===== LOCAL STORAGE KEYS =====
  const todayKey = () => {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  };

  const playsKey = () => `sakuraDemo:plays:${todayKey()}`;
  const prizeKey = () => `sakuraDemo:unclaimedPrize`;

  function getPlaysToday() {
    return Number(localStorage.getItem(playsKey()) || "0");
  }
  function incPlaysToday() {
    localStorage.setItem(playsKey(), String(getPlaysToday() + 1));
  }

  function getUnclaimedPrize() {
    try {
      const raw = localStorage.getItem(prizeKey());
      return raw ? JSON.parse(raw) : null;
    } catch {
      return null;
    }
  }
  function setUnclaimedPrize(obj) {
    localStorage.setItem(prizeKey(), JSON.stringify(obj));
  }
  function clearUnclaimedPrize() {
    localStorage.removeItem(prizeKey());
  }

  // ===== UI HELPERS =====
  function setToast(html) { toastEl.innerHTML = html || ""; }

  function resetHud() {
    score = 0;
    tLeft = GAME_SECONDS;
    scoreEl.textContent = String(score);
    timeEl.textContent = tLeft.toFixed(1);
  }

  function showHow() {
    alert(
`How it works:
‚Ä¢ Tap petals to score.
‚Ä¢ Game lasts ${GAME_SECONDS} seconds.
‚Ä¢ Prize ranges:
   - 15‚Äì30: Miso Soup
   - 31‚Äì50: Miso Soup + Soft Drink
   - 51+: A Meal
‚Ä¢ One play per day (per device).
‚Ä¢ One prize at a time (redeem before playing again).`
    );
  }

  function updateLocksUI() {
    const plays = getPlaysToday();
    const unclaimed = getUnclaimedPrize();

    limitMsg.style.display = "none";
    prizeBlockMsg.style.display = "none";

    if (unclaimed) {
      prizeBlockMsg.style.display = "block";
      prizeBlockMsg.innerHTML =
        `You have an unclaimed prize: <b>${unclaimed.prizeLabel}</b>.<br>` +
        `Redeem it first: <a href="./redeem.html">Open staff redeem</a>`;
      startBtn.disabled = true;
      startBtn.style.opacity = "0.5";
      startBtn.style.cursor = "not-allowed";
      return;
    }

    if (plays >= DAILY_PLAY_LIMIT) {
      limitMsg.style.display = "block";
      limitMsg.textContent = "You‚Äôve already played today. Scan again tomorrow üå∏";
      startBtn.disabled = true;
      startBtn.style.opacity = "0.5";
      startBtn.style.cursor = "not-allowed";
      return;
    }

    startBtn.disabled = false;
    startBtn.style.opacity = "1";
    startBtn.style.cursor = "pointer";
  }

  // ===== VOUCHER CODE GEN =====
  function randomCode(len=8){
    const alphabet = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let out = "";
    for (let i=0;i<len;i++) out += alphabet[Math.floor(Math.random()*alphabet.length)];
    return out;
  }

  function makeVoucher(score){
    const prize = prizeForScore(score);
    if (!prize) return null;
    return {
      code: `YMS-SAKURA-${randomCode(8)}`,
      prizeTier: prize.tier,
      prizeLabel: prize.label,
      score,
      createdAt: new Date().toISOString(),
      status: "UNCLAIMED"
    };
  }

  // ===== PETALS =====
  function spawnPetal() {
    const rect = stage.getBoundingClientRect();
    const x = 12 + Math.random() * (rect.width - 24);
    const y = -10;
    const speed = FALL_SPEED_MIN + Math.random() * (FALL_SPEED_MAX - FALL_SPEED_MIN);

    const el = document.createElement("div");
    el.className = "petal";
    el.style.left = x + "px";
    el.style.top = y + "px";
    el.style.transform = `translate(-50%, -50%) rotate(${Math.random()*360}deg)`;
    stage.appendChild(el);

    const petal = { el, x, y, speed, rot: Math.random()*360, rotSpeed: (Math.random()*120 - 60) };

    el.addEventListener("pointerdown", (e) => {
      if (!running) return;
      e.preventDefault();

      score += 1;
      scoreEl.textContent = String(score);

      removePetal(petal);

      setToast("üå∏ +1");
      clearTimeout(setToast._t);
      setToast._t = setTimeout(() => setToast(""), 400);
    }, { passive:false });

    petals.push(petal);
  }

  function removePetal(petal) {
    petal.el.remove();
    petals = petals.filter(p => p !== petal);
  }

  function clearAllPetals() {
    petals.forEach(p => p.el.remove());
    petals = [];
  }

  // ===== GAME LOOP =====
  function loop(ts) {
    if (!running) return;
    if (lastTs == null) lastTs = ts;
    const dt = Math.min(0.033, (ts - lastTs) / 1000);
    lastTs = ts;

    tLeft -= dt;
    timeEl.textContent = Math.max(0, tLeft).toFixed(1);

    spawnAcc += dt * SPAWN_PER_SEC;
    while (spawnAcc >= 1) {
      spawnPetal();
      spawnAcc -= 1;
    }

    const rect = stage.getBoundingClientRect();
    for (const p of [...petals]) {
      p.y += p.speed * dt;
      p.rot += p.rotSpeed * dt;
      p.el.style.top = p.y + "px";
      p.el.style.transform = `translate(-50%, -50%) rotate(${p.rot}deg)`;
      if (p.y > rect.height + 40) removePetal(p);
    }

    if (tLeft <= 0) endGame();
    else rafId = requestAnimationFrame(loop);
  }

  function startGame() {
    updateLocksUI();
    const plays = getPlaysToday();
    const unclaimed = getUnclaimedPrize();

    if (unclaimed) return;
    if (plays >= DAILY_PLAY_LIMIT) return;

    incPlaysToday();
    resetHud();
    clearAllPetals();
    setToast("");
    overlay.style.display = "none";

    running = true;
    lastTs = null;
    spawnAcc = 0;
    rafId = requestAnimationFrame(loop);
  }

  function endGame() {
    running = false;
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;

    clearAllPetals();

    const prize = prizeForScore(score);

    overlay.style.display = "grid";

    if (!prize) {
      overlay.innerHTML = `
        <div class="stack">
          <div style="font-weight:900;font-size:18px;">Time!</div>
          <div>üå∏ Your score: <b>${score}</b></div>
          <div style="font-weight:900;font-size:16px;margin-top:6px;">No prize today</div>
          <div class="small">Try again tomorrow üå∏</div>
          <div class="small">Tip: Aim for 15‚Äì30 (Miso Soup), 31‚Äì50 (Miso Soup + Soft Drink) or 51+ (A Meal).</div>
          <button class="btn" id="okBtn">OK</button>
          <div class="small">Limit: ${DAILY_PLAY_LIMIT} play/day per device (demo mode).</div>
        </div>
      `;
      document.getElementById("okBtn").onclick = () => location.reload();
      return;
    }

    // Prize won -> create voucher and BLOCK further play until redeemed
    const voucher = makeVoucher(score);
    setUnclaimedPrize(voucher);

    overlay.innerHTML = `
      <div class="stack">
        <div style="font-weight:900;font-size:18px;">You won! üéâ</div>
        <div>üå∏ Your score: <b>${score}</b></div>

        <div style="margin-top:6px;">
          <div style="font-weight:900;font-size:16px;">Prize: ${voucher.prizeLabel}</div>
          <div class="small">Show this code at the counter.</div>
          <div class="code">${voucher.code}</div>
          <div class="small" style="margin-top:6px;">One prize at a time: redeem before playing again.</div>
        </div>

        <button class="btn" id="redeemBtn">Open Staff Redeem</button>
        <button class="btn secondary" id="shareBtn">Share</button>

        <div class="small">Demo mode (no server). Official campaign will validate centrally.</div>
      </div>
    `;

    document.getElementById("redeemBtn").onclick = () => {
      location.href = "./redeem.html";
    };

    document.getElementById("shareBtn").onclick = async () => {
      const text = `I scored ${score} in the Sakura Season game üå∏`;
      const shareData = { title: "Sakura Season", text, url: location.href };
      try {
        if (navigator.share) await navigator.share(shareData);
        else {
          await navigator.clipboard.writeText(`${text} ${location.href}`);
          alert("Copied to clipboard!");
        }
      } catch {}
    };
  }

  // ===== EVENTS =====
  startBtn.addEventListener("click", startGame);
  howBtn.addEventListener("click", showHow);

  // Initialize locks
  updateLocksUI();
})();
</script>
</body>
</html>
