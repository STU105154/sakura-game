<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Sakura Season ‚Äì Catch the Petals</title>

  <style>
    :root { --pad: 16px; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(circle at top, #ffe8f2, #fff);
      color: #111;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card {
      width: min(520px, calc(100vw - 24px));
      background: rgba(255,255,255,0.88);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    header { padding: 18px 18px 10px; }
    h1 { font-size: 18px; margin: 0 0 6px; }
    p { margin: 0; opacity: 0.75; line-height: 1.35; font-size: 14px; }

    .stageWrap { padding: 0 18px 18px; }

    #stage {
      position: relative;
      width: 100%;
      aspect-ratio: 9 / 14;
      background: linear-gradient(180deg, rgba(255,210,230,0.55), rgba(255,255,255,0.95));
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.06);
      touch-action: manipulation;
    }

    .hud {
      position: absolute; top: 10px; left: 10px; right: 10px;
      display: flex; justify-content: space-between; gap: 10px;
      pointer-events: none;
      z-index: 2;
    }

    .pill {
      padding: 8px 10px;
      background: rgba(255,255,255,0.85);
      border: 1px solid rgba(0,0,0,0.07);
      border-radius: 999px;
      font-weight: 600;
      font-size: 13px;
      backdrop-filter: blur(6px);
    }

    .center {
      position: absolute; inset: 0;
      display: grid;
      place-items: center;
      padding: 18px;
      text-align: center;
      z-index: 3;
    }

    .btn {
      appearance: none;
      border: 0;
      border-radius: 14px;
      padding: 12px 16px;
      font-weight: 800;
      font-size: 15px;
      background: #111;
      color: #fff;
      width: min(280px, 100%);
      cursor: pointer;
    }
    .btn.secondary { background: #fff; color: #111; border: 1px solid rgba(0,0,0,0.12); }

    .stack { display: grid; gap: 10px; justify-items: center; }
    .small { font-size: 12px; opacity: 0.72; line-height: 1.35; }

    .petal {
      position: absolute;
      width: 36px; height: 36px;
      transform: translate(-50%, -50%) rotate(0deg);
      border-radius: 12px 18px 12px 18px;
      background: radial-gradient(circle at 30% 30%, #fff, #ffb4d1 55%, #ff8ab8);
      box-shadow: 0 8px 16px rgba(255, 110, 170, 0.18);
      border: 1px solid rgba(0,0,0,0.05);
      user-select: none;
    }

    .petal:before {
      content: "";
      position: absolute;
      inset: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.55);
      filter: blur(0.2px);
    }

    .toast {
      position: absolute; bottom: 10px; left: 10px; right: 10px;
      display: grid; place-items: center;
      pointer-events: none;
      font-size: 12px;
      opacity: 0.85;
      z-index: 4;
    }

    .code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      padding: 9px 12px;
      background: rgba(0,0,0,0.06);
      border-radius: 10px;
      display: inline-block;
      margin-top: 6px;
      font-weight: 800;
      letter-spacing: 0.2px;
    }

    .badge {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,0.06);
      border: 1px solid rgba(0,0,0,0.08);
      font-weight: 800;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="card">
    <header>
      <h1>üå∏ Sakura Season ‚Äì Catch the Petals</h1>
      <p>Tap as many petals as you can in <b>15 seconds</b>.</p>
      <p class="small" style="margin-top:6px;">
        Prizes: <b>15‚Äì30</b> petals = <b>Miso Soup</b> ‚Ä¢ <b>51+</b> petals = <b>A Meal</b>
      </p>
    </header>

    <div class="stageWrap">
      <div id="stage" aria-label="Game area">
        <div class="hud">
          <div class="pill">‚è± <span id="time">15.0</span>s</div>
          <div class="pill">üå∏ Petals: <span id="score">0</span></div>
        </div>

        <div class="center" id="overlay">
          <div class="stack">
            <div>
              <div style="font-weight:900;font-size:18px;">Ready?</div>
              <div class="small">One play per day (per device). Scan again tomorrow üå∏</div>
            </div>

            <button class="btn" id="startBtn">Start</button>
            <button class="btn secondary" id="howBtn">How it works</button>

            <div class="small" id="limitMsg" style="display:none;"></div>
          </div>
        </div>

        <div class="toast" id="toast"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ====== CONFIG ======
  const GAME_SECONDS = 15;
  const SPAWN_PER_SEC = 2.2;        // petals per second (avg)
  const FALL_SPEED_MIN = 120;       // px/s
  const FALL_SPEED_MAX = 260;       // px/s
  const DAILY_PLAY_LIMIT = 1;       // per device (demo/basic)

  // ====== REWARD RULES (YOUR CAMPAIGN) ======
  // 1) 15‚Äì30 petals => Miso Soup
  // 2) 51+ petals   => A Meal
  // else: no prize
  function rewardForScore(score) {
    if (score >= 51) {
      return { won: true, tier: 2, label: "A Meal", code: "YMS-SAKURA-MEAL" };
    }
    if (score >= 15 && score <= 30) {
      return { won: true, tier: 1, label: "Miso Soup", code: "YMS-SAKURA-MISO" };
    }
    return { won: false, tier: 0, label: "No prize today", code: "" };
  }

  // ====== ELEMENTS ======
  const stage = document.getElementById("stage");
  const overlay = document.getElementById("overlay");
  const startBtn = document.getElementById("startBtn");
  const howBtn = document.getElementById("howBtn");
  const scoreEl = document.getElementById("score");
  const timeEl = document.getElementById("time");
  const toastEl = document.getElementById("toast");
  const limitMsg = document.getElementById("limitMsg");

  // ====== STATE ======
  let running = false;
  let score = 0;
  let tLeft = GAME_SECONDS;
  let lastTs = null;
  let spawnAcc = 0;
  let petals = [];
  let rafId = null;

  // ====== DAILY LIMIT (basic / per device) ======
  const todayKey = () => {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  };
  const limitStorageKey = () => `sakuraPlays:${todayKey()}`;

  function getPlaysToday() {
    return Number(localStorage.getItem(limitStorageKey()) || "0");
  }
  function incPlaysToday() {
    localStorage.setItem(limitStorageKey(), String(getPlaysToday() + 1));
  }

  // ====== UI HELPERS ======
  function setToast(html) { toastEl.innerHTML = html || ""; }

  function resetHud() {
    score = 0;
    tLeft = GAME_SECONDS;
    scoreEl.textContent = String(score);
    timeEl.textContent = tLeft.toFixed(1);
  }

  function showHow() {
    alert(
`How it works:

‚Ä¢ Tap petals to score.
‚Ä¢ You have ${GAME_SECONDS} seconds.
‚Ä¢ Prizes:
  - 15‚Äì30 petals: Miso Soup
  - 51+ petals: A Meal

Rules:
‚Ä¢ One play per day (per device).
‚Ä¢ One prize at a time ‚Äî prizes cannot be stacked.
‚Ä¢ Redeem at any You Me Sushi restaurant.`
    );
  }

  // ====== PETAL SPAWN ======
  function spawnPetal() {
    const rect = stage.getBoundingClientRect();
    const x = 12 + Math.random() * (rect.width - 24);
    const y = -10;
    const speed = FALL_SPEED_MIN + Math.random() * (FALL_SPEED_MAX - FALL_SPEED_MIN);

    const el = document.createElement("div");
    el.className = "petal";
    el.style.left = x + "px";
    el.style.top = y + "px";
    el.style.transform = `translate(-50%, -50%) rotate(${Math.random()*360}deg)`;
    stage.appendChild(el);

    const petal = { el, x, y, speed, rot: Math.random()*360, rotSpeed: (Math.random()*120 - 60) };

    el.addEventListener("pointerdown", (e) => {
      if (!running) return;
      e.preventDefault();

      score += 1;
      scoreEl.textContent = String(score);

      removePetal(petal);

      setToast("üå∏ +1");
      clearTimeout(setToast._t);
      setToast._t = setTimeout(() => setToast(""), 350);
    }, { passive: false });

    petals.push(petal);
  }

  function removePetal(petal) {
    petal.el.remove();
    petals = petals.filter(p => p !== petal);
  }

  function clearAllPetals() {
    petals.forEach(p => p.el.remove());
    petals = [];
  }

  // ====== GAME LOOP ======
  function loop(ts) {
    if (!running) return;
    if (lastTs == null) lastTs = ts;
    const dt = Math.min(0.033, (ts - lastTs) / 1000);
    lastTs = ts;

    // timer
    tLeft -= dt;
    timeEl.textContent = Math.max(0, tLeft).toFixed(1);

    // spawn
    spawnAcc += dt * SPAWN_PER_SEC;
    while (spawnAcc >= 1) {
      spawnPetal();
      spawnAcc -= 1;
    }

    // update petals
    const rect = stage.getBoundingClientRect();
    for (const p of [...petals]) {
      p.y += p.speed * dt;
      p.rot += p.rotSpeed * dt;
      p.el.style.top = p.y + "px";
      p.el.style.transform = `translate(-50%, -50%) rotate(${p.rot}deg)`;
      if (p.y > rect.height + 40) removePetal(p);
    }

    if (tLeft <= 0) endGame();
    else rafId = requestAnimationFrame(loop);
  }

  function startGame() {
    const plays = getPlaysToday();
    if (plays >= DAILY_PLAY_LIMIT) {
      limitMsg.style.display = "block";
      limitMsg.textContent = "You‚Äôve already played today. Scan again tomorrow üå∏";
      return;
    }

    incPlaysToday();
    limitMsg.style.display = "none";

    resetHud();
    clearAllPetals();
    setToast("");
    overlay.style.display = "none";

    running = true;
    lastTs = null;
    spawnAcc = 0;
    rafId = requestAnimationFrame(loop);
  }

  function endGame() {
    running = false;
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;

    clearAllPetals();

    const reward = rewardForScore(score);

    overlay.style.display = "grid";
    overlay.innerHTML = `
      <div class="stack">
        <div style="font-weight:900;font-size:18px;">Time!</div>
        <div>üå∏ Your score: <b>${score}</b></div>

        ${
          reward.won
            ? `
              <div style="margin-top:6px;">
                <div class="badge">Prize ${reward.tier}</div>
                <div style="font-weight:900;margin-top:8px;">You won: ${reward.label}</div>
                <div class="small">Show this screen at the counter to redeem.</div>
                <div class="code">CODE: ${reward.code}</div>
                <div class="small" style="margin-top:10px;">
                  Rules: One prize at a time. Prizes cannot be stacked. Redeem at any You Me Sushi restaurant.
                </div>
              </div>
            `
            : `
              <div style="margin-top:6px;">
                <div style="font-weight:900;">No prize today</div>
                <div class="small">
                  Try again tomorrow üå∏ <br/>
                  Tip: Aim for <b>15‚Äì30</b> (Miso Soup) or <b>51+</b> (A Meal).
                </div>
              </div>
            `
        }

        <button class="btn" id="againBtn">Play again</button>
        <button class="btn secondary" id="shareBtn">Share</button>

        <div class="small">Limit: ${DAILY_PLAY_LIMIT} play/day per device (demo mode).</div>
      </div>
    `;

    document.getElementById("againBtn").onclick = () => {
      location.reload();
    };

    document.getElementById("shareBtn").onclick = async () => {
      const text = `I scored ${score} in the Sakura Season game üå∏`;
      const shareData = { title: "Sakura Season", text, url: location.href };
      try {
        if (navigator.share) await navigator.share(shareData);
        else {
          await navigator.clipboard.writeText(`${text} ${location.href}`);
          alert("Copied to clipboard!");
        }
      } catch {}
    };
  }

  // ====== EVENTS ======
  startBtn.addEventListener("click", startGame);
  howBtn.addEventListener("click", showHow);

  // If already played today, show message immediately
  if (getPlaysToday() >= DAILY_PLAY_LIMIT) {
    limitMsg.style.display = "block";
    limitMsg.textContent = "You‚Äôve already played today. Scan again tomorrow üå∏";
  }
})();
</script>
</body>
</html>
