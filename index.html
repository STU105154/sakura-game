<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Sakura Tap (Demo) ‚Äî Catch the Petals</title>

  <style>
    :root{
      --text:#f7f3ea;
      --muted: rgba(247,243,234,.75);
      --panel: rgba(0,0,0,.40);
      --stroke: rgba(255,255,255,.14);
      --gold:#d4a956;

      --pink1:#ffb4d1;
      --pink2:#ff8ab8;

      --pad:16px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#000;
      color:var(--text);
      overflow:hidden;
    }

    /* ‚úÖ Background Sakura */
    .bg{
      position:fixed; inset:0;
      background:
        linear-gradient(rgba(0,0,0,.20), rgba(0,0,0,.55)),
        url("./assets/images/sakura-bg.png");
      background-size:cover;
      background-position:center;
      transform:scale(1.02);
      filter:saturate(1.05);
    }
    .vignette{
      position:fixed; inset:0;
      background: radial-gradient(circle at 50% 20%, rgba(255,255,255,.06), rgba(0,0,0,.70) 72%);
      pointer-events:none;
    }

    /* Main card */
    .card{
      position:relative;
      width:min(720px, calc(100vw - 24px));
      margin: 0 auto;
      top: 12px;
      background: rgba(0,0,0,0.32);
      border:1px solid var(--stroke);
      border-radius: 22px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.55);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    header{ padding: 16px 16px 10px; }
    h1{ font-size: 20px; margin: 0 0 6px; }
    p{ margin:0; color: var(--muted); line-height:1.35; font-size:13px; }

    .rules{
      margin-top:10px;
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.35;
    }
    .rules b{ color: var(--text); }

    .stageWrap{ padding: 0 16px 16px; }

    #stage{
      position: relative;
      width: 100%;
      height: min(74vh, 820px);
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.10);
      touch-action: manipulation;
    }

    .hud{
      position:absolute; top:10px; left:10px; right:10px;
      display:flex; justify-content:space-between; gap:10px;
      pointer-events:none;
      z-index: 5;
    }
    .pill{
      padding: 8px 10px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 999px;
      font-weight: 800;
      font-size: 12.5px;
      backdrop-filter: blur(6px);
      color: var(--text);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .dot{
      width:10px; height:10px;
      border-radius:999px;
      background: var(--gold);
      border:1px solid rgba(255,255,255,.22);
      box-shadow: 0 0 14px rgba(212,169,86,.15);
    }

    .center{
      position:absolute; inset:0;
      display:grid;
      place-items:center;
      padding:18px;
      text-align:center;
      z-index: 10;
      background: radial-gradient(circle at 50% 20%, rgba(0,0,0,.10), rgba(0,0,0,.35));
    }

    .stack{ display:grid; gap:10px; justify-items:center; max-width: 520px; }

    .btn{
      appearance:none;
      border:1px solid rgba(212,169,86,.45);
      border-radius:14px;
      padding:12px 16px;
      font-weight:900;
      font-size:14.5px;
      background: rgba(0,0,0,.35);
      color:#fff;
      width:min(320px, 100%);
      cursor:pointer;
    }
    .btn:hover{ background: rgba(212,169,86,.10); }

    .btn.secondary{
      background: rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.18);
      color:#fff;
      font-weight:900;
    }
    .btn.secondary:hover{ background: rgba(255,255,255,0.12); }

    .small{ font-size: 12px; color: var(--muted); line-height: 1.35; }
    .small a{ color:#fff; }

    .notice{
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      color: rgba(247,243,234,0.80);
      line-height: 1.35;
      text-align:left;
      width:100%;
    }

    /* Petals */
    .petal{
      position:absolute;
      transform: translate(-50%,-50%) rotate(0deg);
      border-radius: 12px 18px 12px 18px;
      border: 1px solid rgba(255,255,255,0.12);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
    }

    /* ‚úÖ Pink decoy */
    .petal.pink{
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,255,255,0) 55%),
        radial-gradient(circle at 30% 25%, var(--pink1), rgba(255,255,255,.10) 64%),
        linear-gradient(140deg, rgba(255,200,230,.95), rgba(255,95,170,.65));
      box-shadow: 0 10px 22px rgba(255,110,170, 0.18);
    }

    /* ‚úÖ Gold target (ONLY this counts) */
    .petal.gold{
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,255,255,0) 55%),
        radial-gradient(circle at 30% 25%, rgba(212,169,86,.98), rgba(255,255,255,.10) 64%),
        linear-gradient(140deg, rgba(255,255,255,.16), rgba(212,169,86,.65));
      border-color: rgba(212,169,86,.75);
      box-shadow: 0 10px 22px rgba(212,169,86, 0.18);
      animation: pulse 780ms ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ transform: translate(-50%,-50%) scale(1) rotate(var(--rot)); }
      50%{ transform: translate(-50%,-50%) scale(1.08) rotate(var(--rot)); }
    }

    .petal::before{
      content:"";
      position:absolute;
      inset:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,0.55);
      filter: blur(0.2px);
      opacity:.55;
    }

    .toast{
      position:absolute; bottom:10px; left:10px; right:10px;
      display:grid; place-items:center;
      pointer-events:none;
      font-size:12px;
      opacity:.90;
      min-height: 18px;
      z-index: 6;
      color: rgba(247,243,234,.92);
      text-shadow: 0 2px 14px rgba(0,0,0,.6);
    }

    .code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      padding: 10px 12px;
      background: rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.14);
      border-radius: 12px;
      display:inline-block;
      margin-top: 8px;
      letter-spacing: 0.8px;
      font-weight: 900;
      color:#fff;
    }

    .warn{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(251,113,133,.35);
      background: rgba(251,113,133,.10);
      color: rgba(247,243,234,.88);
      font-size:12px;
      line-height:1.35;
      width:100%;
      text-align:left;
    }
    .warn code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size:12px;
    }
  </style>
</head>

<body>
  <div class="bg" id="bg"></div>
  <div class="vignette"></div>

  <div class="card">
    <header>
      <h1>Sakura Tap (15s)</h1>
      <p><b style="color:var(--gold)">Tap ONLY the gold petals.</b> Pink petals don‚Äôt count.</p>

      <div class="rules">
        Scoring prizes:
        <b>18‚Äì24</b> = <b>Free miso soup</b> ‚Ä¢
        <b>25‚Äì29</b> = <b>50% next purchase</b> ‚Ä¢
        <b>30+</b> = <b>Free katsu curry</b>
      </div>
      <div class="rules">Demo mode: <b>1 play/day</b> (per device) + <b>1 prize at a time</b> (redeem before playing again).</div>
    </header>

    <div class="stageWrap">
      <div id="stage" aria-label="Game area">
        <div class="hud">
          <div class="pill">‚è± <span id="time">15.0</span>s</div>
          <div class="pill"><span class="dot"></span> Score: <span id="score">0</span></div>
        </div>

        <div class="center" id="overlay">
          <div class="stack" id="overlayInner">
            <div style="font-weight:950;font-size:18px;">Ready?</div>
            <div class="small">
              Tap <b>gold petals only</b>. The game speeds up as time goes on.
            </div>

            <button class="btn" id="startBtn">Start</button>
            <button class="btn secondary" id="howBtn">How it works</button>
            <button class="btn secondary" id="soundBtn">Sound: ON</button>

            <div class="small" id="limitMsg" style="display:none;"></div>
            <div class="small" id="prizeBlockMsg" style="display:none;"></div>

            <div id="bgWarn" class="warn" style="display:none;"></div>

            <div class="notice">
              Demo mode: limits are stored on this device/browser. For the official campaign we‚Äôll enable server validation.
            </div>
          </div>
        </div>

        <div class="toast" id="toast"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ===============================
  // CONFIG
  // ===============================
  const BG_PATH = "./assets/images/sakura-bg.png";
  const GAME_SECONDS = 15;

  // Difficulty scaling across 15s (3 phases)
  // Goal: hard to hit 25, brutal to hit 30
  const PHASES = [
    // 0‚Äì5s
    { t: 0,  spawnPerSec: 3.0, goldChance: 0.38, size: 42, speedMin: 130, speedMax: 240, drift: 0.0,  cooldownMs: 0 },
    // 5‚Äì10s
    { t: 5,  spawnPerSec: 4.6, goldChance: 0.30, size: 36, speedMin: 170, speedMax: 320, drift: 0.25, cooldownMs: 35 },
    // 10‚Äì15s
    { t: 10, spawnPerSec: 6.4, goldChance: 0.22, size: 30, speedMin: 220, speedMax: 420, drift: 0.55, cooldownMs: 70 },
  ];

  // Demo locks
  const DAILY_PLAY_LIMIT = 1;
  const prizeKey = () => `sakuraDemo:unclaimedPrize`;
  const playsKey = () => {
    const d = new Date();
    const day = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    return `sakuraDemo:plays:${day}`;
  };

  // Prize rules (NEW)
  function prizeForScore(score) {
    if (score >= 30) return { tier: 3, label: "Free katsu curry" };
    if (score >= 25) return { tier: 2, label: "50% next purchase" };
    if (score >= 18) return { tier: 1, label: "Free miso soup" };
    return null;
  }

  // ===============================
  // ELEMENTS
  // ===============================
  const stage = document.getElementById("stage");
  const overlay = document.getElementById("overlay");
  const startBtn = document.getElementById("startBtn");
  const howBtn = document.getElementById("howBtn");
  const soundBtn = document.getElementById("soundBtn");
  const scoreEl = document.getElementById("score");
  const timeEl = document.getElementById("time");
  const toastEl = document.getElementById("toast");
  const limitMsg = document.getElementById("limitMsg");
  const prizeBlockMsg = document.getElementById("prizeBlockMsg");
  const bgWarn = document.getElementById("bgWarn");

  // ===============================
  // STATE
  // ===============================
  let running = false;
  let soundOn = true;

  let score = 0;
  let tLeft = GAME_SECONDS;
  let startTs = 0;
  let lastTs = null;

  let spawnAcc = 0;
  let petals = [];
  let rafId = null;

  let lastTapAt = 0;

  // ===============================
  // BG CHECK (helpful)
  // ===============================
  (function checkBg(){
    const img = new Image();
    img.onload = () => {};
    img.onerror = () => {
      bgWarn.style.display = "block";
      bgWarn.innerHTML =
        `Background image not found.<br>` +
        `Expected: <code>assets/images/sakura-bg.png</code><br>` +
        `(GitHub Pages is case-sensitive.)`;
      // fallback background
      document.getElementById("bg").style.background =
        "linear-gradient(rgba(0,0,0,.20), rgba(0,0,0,.65)), radial-gradient(circle at 30% 20%, rgba(255,182,210,.18), rgba(0,0,0,.9) 72%)";
    };
    img.src = BG_PATH + "?v=" + Date.now();
  })();

  // ===============================
  // LOCAL STORAGE
  // ===============================
  function getPlaysToday() { return Number(localStorage.getItem(playsKey()) || "0"); }
  function incPlaysToday() { localStorage.setItem(playsKey(), String(getPlaysToday() + 1)); }

  function getUnclaimedPrize() {
    try {
      const raw = localStorage.getItem(prizeKey());
      return raw ? JSON.parse(raw) : null;
    } catch { return null; }
  }
  function setUnclaimedPrize(obj) { localStorage.setItem(prizeKey(), JSON.stringify(obj)); }
  function clearUnclaimedPrize() { localStorage.removeItem(prizeKey()); }

  // ===============================
  // UI
  // ===============================
  function setToast(html) {
    toastEl.innerHTML = html || "";
  }

  function resetHud() {
    score = 0;
    tLeft = GAME_SECONDS;
    scoreEl.textContent = String(score);
    timeEl.textContent = tLeft.toFixed(1);
  }

  function showHow() {
    alert(
`How it works:
‚Ä¢ Tap ONLY gold petals (pink petals don‚Äôt count).
‚Ä¢ Game lasts ${GAME_SECONDS} seconds.
‚Ä¢ Prizes:
   - 18‚Äì24: Free miso soup
   - 25‚Äì29: 50% next purchase
   - 30+: Free katsu curry
‚Ä¢ Difficulty increases as time goes on.
‚Ä¢ Demo mode:
   - 1 play/day per device
   - 1 prize at a time (redeem before playing again)`
    );
  }

  function updateLocksUI() {
    const plays = getPlaysToday();
    const unclaimed = getUnclaimedPrize();

    limitMsg.style.display = "none";
    prizeBlockMsg.style.display = "none";

    if (unclaimed) {
      prizeBlockMsg.style.display = "block";
      prizeBlockMsg.innerHTML =
        `You have an unclaimed prize: <b>${unclaimed.prizeLabel}</b>.<br>` +
        `Redeem it first: <a href="./redeem.html">Open staff redeem</a>`;
      startBtn.disabled = true;
      startBtn.style.opacity = "0.5";
      startBtn.style.cursor = "not-allowed";
      return;
    }

    if (plays >= DAILY_PLAY_LIMIT) {
      limitMsg.style.display = "block";
      limitMsg.textContent = "You‚Äôve already played today. Scan again tomorrow üå∏";
      startBtn.disabled = true;
      startBtn.style.opacity = "0.5";
      startBtn.style.cursor = "not-allowed";
      return;
    }

    startBtn.disabled = false;
    startBtn.style.opacity = "1";
    startBtn.style.cursor = "pointer";
  }

  // ===============================
  // SOUND (tap noise)
  // ===============================
  let audioCtx = null;
  function ensureAudio(){
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if(audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
  }
  function tapSound(ok){
    if(!soundOn) return;
    ensureAudio();
    const t = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();

    o.type = "triangle";
    o.frequency.setValueAtTime(ok ? 880 : 220, t);
    o.frequency.exponentialRampToValueAtTime(ok ? 1400 : 260, t + 0.05);

    g.gain.setValueAtTime(ok ? 0.07 : 0.09, t);
    g.gain.exponentialRampToValueAtTime(0.001, t + 0.07);

    o.connect(g); g.connect(audioCtx.destination);
    o.start(t); o.stop(t + 0.08);
  }

  // ===============================
  // VOUCHER
  // ===============================
  function randomCode(len=8){
    const alphabet = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let out = "";
    for (let i=0;i<len;i++) out += alphabet[Math.floor(Math.random()*alphabet.length)];
    return out;
  }

  function makeVoucher(score){
    const prize = prizeForScore(score);
    if (!prize) return null;
    return {
      code: `YMS-SAKURA-${randomCode(8)}`,
      prizeTier: prize.tier,
      prizeLabel: prize.label,
      score,
      createdAt: new Date().toISOString(),
      status: "UNCLAIMED"
    };
  }

  // ===============================
  // DIFFICULTY
  // ===============================
  function phaseForElapsed(elapsed){
    // elapsed in seconds
    if (elapsed >= PHASES[2].t) return PHASES[2];
    if (elapsed >= PHASES[1].t) return PHASES[1];
    return PHASES[0];
  }

  // ===============================
  // PETALS (fall from top)
  // ===============================
  function spawnPetal(elapsed){
    const cfg = phaseForElapsed(elapsed);
    const rect = stage.getBoundingClientRect();

    const isGold = Math.random() < cfg.goldChance;

    const size = cfg.size + Math.floor(Math.random()*3); // tiny variance
    const x = 10 + Math.random() * (rect.width - 20);
    const y = -20;

    const speed = cfg.speedMin + Math.random() * (cfg.speedMax - cfg.speedMin);
    const drift = (Math.random()*2 - 1) * cfg.drift; // px per frame-ish modifier

    const el = document.createElement("div");
    el.className = "petal " + (isGold ? "gold" : "pink");
    el.style.width = size + "px";
    el.style.height = size + "px";

    const rot = Math.random()*360;
    el.style.setProperty("--rot", rot + "deg");
    el.style.left = x + "px";
    el.style.top = y + "px";
    el.style.transform = `translate(-50%, -50%) rotate(${rot}deg)`;

    stage.appendChild(el);

    const petal = {
      el,
      x, y,
      size,
      isGold,
      speed,
      vx: drift * 60,     // convert to px/sec-ish
      rot,
      rotSpeed: (Math.random()*120 - 60)
    };

    el.addEventListener("pointerdown", (e) => {
      if (!running) return;
      e.preventDefault();

      const now = performance.now();
      const cooldown = cfg.cooldownMs || 0;
      if (cooldown && (now - lastTapAt) < cooldown) return;
      lastTapAt = now;

      if (!petal.isGold){
        tapSound(false);
        el.classList.add("wrongFlash");
        setTimeout(()=> el.classList.remove("wrongFlash"), 220);
        return;
      }

      tapSound(true);

      score += 1;
      scoreEl.textContent = String(score);
      removePetal(petal);

      setToast("üå∏ +1");
      clearTimeout(setToast._t);
      setToast._t = setTimeout(() => setToast(""), 300);
    }, { passive:false });

    petals.push(petal);
  }

  function removePetal(petal){
    petal.el.remove();
    petals = petals.filter(p => p !== petal);
  }

  function clearAllPetals(){
    petals.forEach(p => p.el.remove());
    petals = [];
  }

  // ===============================
  // GAME LOOP
  // ===============================
  function loop(ts){
    if(!running) return;
    if(lastTs == null) lastTs = ts;

    const dt = Math.min(0.033, (ts - lastTs) / 1000);
    lastTs = ts;

    const elapsed = (ts - startTs) / 1000;
    const cfg = phaseForElapsed(elapsed);

    tLeft = Math.max(0, GAME_SECONDS - elapsed);
    timeEl.textContent = tLeft.toFixed(1);

    // spawn
    spawnAcc += dt * cfg.spawnPerSec;
    while(spawnAcc >= 1){
      spawnPetal(elapsed);
      spawnAcc -= 1;
    }

    // update petals
    const rect = stage.getBoundingClientRect();
    for(const p of [...petals]){
      p.y += p.speed * dt;
      p.x += p.vx * dt;

      // gentle lateral bounce
      if (p.x < 10){ p.x = 10; p.vx *= -1; }
      if (p.x > rect.width - 10){ p.x = rect.width - 10; p.vx *= -1; }

      p.rot += p.rotSpeed * dt;

      p.el.style.left = p.x + "px";
      p.el.style.top = p.y + "px";
      p.el.style.transform = `translate(-50%, -50%) rotate(${p.rot}deg)`;

      if(p.y > rect.height + 60) removePetal(p);
    }

    if(tLeft <= 0.001){
      endGame();
      return;
    }

    rafId = requestAnimationFrame(loop);
  }

  function startGame(){
    updateLocksUI();
    const plays = getPlaysToday();
    const unclaimed = getUnclaimedPrize();
    if(unclaimed) return;
    if(plays >= DAILY_PLAY_LIMIT) return;

    ensureAudio(); // allow sound on mobile after tap
    incPlaysToday();

    resetHud();
    clearAllPetals();
    setToast("");

    overlay.style.display = "none";
    running = true;

    startTs = performance.now();
    lastTs = null;
    spawnAcc = 0;
    lastTapAt = 0;

    rafId = requestAnimationFrame(loop);
  }

  function endGame(){
    running = false;
    if(rafId) cancelAnimationFrame(rafId);
    rafId = null;

    clearAllPetals();

    const prize = prizeForScore(score);
    overlay.style.display = "grid";

    if(!prize){
      overlay.innerHTML = `
        <div class="stack">
          <div style="font-weight:950;font-size:18px;">Time!</div>
          <div>Score: <b style="color:var(--gold)">${score}</b></div>
          <div style="font-weight:950;font-size:16px;margin-top:6px;">No prize today</div>
          <div class="small">Try again tomorrow üå∏</div>
          <button class="btn" id="okBtn">OK</button>
          <div class="small">Limit: ${DAILY_PLAY_LIMIT} play/day per device (demo mode).</div>
        </div>
      `;
      document.getElementById("okBtn").onclick = () => location.reload();
      return;
    }

    // prize won -> create voucher and block further play until redeemed
    const voucher = makeVoucher(score);
    setUnclaimedPrize(voucher);

    overlay.innerHTML = `
      <div class="stack">
        <div style="font-weight:950;font-size:18px;">You won! üéâ</div>
        <div>Score: <b style="color:var(--gold)">${score}</b></div>

        <div style="margin-top:6px;">
          <div style="font-weight:950;font-size:16px;">
            Congratulations! You won <span style="color:var(--gold)">${voucher.prizeLabel}</span> to collect now in store.
          </div>
          <div class="small" style="margin-top:6px;">Show this code at the counter.</div>
          <div class="code">${voucher.code}</div>
          <div class="small" style="margin-top:6px;">One prize at a time: redeem before playing again.</div>
        </div>

        <button class="btn" id="redeemBtn">Open Staff Redeem</button>
        <button class="btn secondary" id="shareBtn">Share</button>

        <div class="small">Demo mode (no server). Official campaign will validate centrally.</div>
      </div>
    `;

    document.getElementById("redeemBtn").onclick = () => {
      location.href = "./redeem.html";
    };

    document.getElementById("shareBtn").onclick = async () => {
      const text = `I scored ${score} in the Sakura Tap game üå∏`;
      const shareData = { title: "Sakura Tap", text, url: location.href };
      try {
        if (navigator.share) await navigator.share(shareData);
        else {
          await navigator.clipboard.writeText(`${text} ${location.href}`);
          alert("Copied to clipboard!");
        }
      } catch {}
    };
  }

  // ===============================
  // EVENTS
  // ===============================
  startBtn.addEventListener("click", startGame);
  howBtn.addEventListener("click", showHow);

  soundBtn.addEventListener("click", () => {
    soundOn = !soundOn;
    soundBtn.textContent = `Sound: ${soundOn ? "ON" : "OFF"}`;
    if(soundOn) ensureAudio();
  });

  // init
  updateLocksUI();
})();
</script>
</body>
</html>
