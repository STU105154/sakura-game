<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Sakura Season ‚Äì Staff Redeem (Demo)</title>
  <style>
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #0b0b0b;
      color:#f7f3ea;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 12px;
    }
    .card{
      width:min(560px, calc(100vw - 24px));
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      box-shadow: 0 18px 48px rgba(0,0,0,0.35);
      overflow:hidden;
    }
    header{ padding: 18px 18px 10px; }
    h1{ margin:0 0 6px; font-size:18px; }
    p{ margin:0; opacity:.75; font-size:13px; line-height:1.35; }

    .wrap{ padding: 0 18px 18px; display:grid; gap:12px; }
    label{ font-size: 12px; opacity:.85; }
    input, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.35);
      color:#fff;
      outline:none;
      font-size: 14px;
    }
    .row{ display:grid; gap:6px; }

    .btnRow{ display:grid; gap:10px; }
    .btn{
      appearance:none;
      border:0;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 900;
      font-size: 14px;
      cursor:pointer;
      background:#fff;
      color:#111;
    }
    .btn.secondary{
      background: transparent;
      color:#fff;
      border:1px solid rgba(255,255,255,0.14);
    }
    .btn.danger{
      background: rgba(255,80,80,0.14);
      color:#fff;
      border:1px solid rgba(255,80,80,0.28);
    }

    .pill{
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      font-size: 13px;
      line-height:1.35;
    }
    .ok{ border-color: rgba(60, 240, 150, 0.30); }
    .bad{ border-color: rgba(255, 80, 80, 0.35); }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      letter-spacing: .4px;
      font-weight: 800;
    }
    .muted{ opacity:.7; font-size: 12px; }
    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .twoCol{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="card">
    <header>
      <h1>üç£ Sakura Season ‚Äì Staff Redeem (Demo)</h1>
      <p>Demo-only redeem screen. This device will mark the current voucher as redeemed.</p>
    </header>

    <div class="wrap">
      <div class="pill" id="currentBox"></div>

      <div class="twoCol">
        <div class="row">
          <label>Branch</label>
          <select id="branch">
            <option>You Me Sushi ‚Äì Hampstead</option>
            <option>You Me Sushi ‚Äì Brent Cross</option>
            <option>You Me Sushi ‚Äì Other</option>
          </select>
        </div>

        <div class="row">
          <label>Staff name (optional)</label>
          <input id="staffName" placeholder="e.g., Ana" />
        </div>
      </div>

      <div class="twoCol">
        <div class="row">
          <label>Staff PIN (demo)</label>
          <input id="pin" placeholder="Enter PIN" inputmode="numeric" />
          <div class="muted">Demo PIN: <span class="mono">2026</span></div>
        </div>

        <div class="row">
          <label>Voucher code</label>
          <input id="code" placeholder="YMS-SAKURA-XXXXXXXX" class="mono" />
          <div class="muted" id="expectedBox" style="display:none;"></div>
        </div>
      </div>

      <div class="btnRow">
        <button class="btn" id="redeemBtn">Redeem</button>
        <button class="btn secondary" id="backBtn">Back to game</button>
        <button class="btn danger" id="resetBtn">Reset demo on this device</button>
      </div>

      <div class="pill" id="resultBox" style="display:none;"></div>

      <div class="muted">
        Tip: you can open this page with <span class="mono">?code=YMS-SAKURA-XXXX</span> to prefill the code.
        Official version will validate centrally (server + database) and prevent fraud across devices.
      </div>
    </div>
  </div>

<script>
(() => {
  const prizeKey = "sakuraDemo:unclaimedPrize";
  const redeemedKey = "sakuraDemo:redeemedLog";
  const DEMO_PIN = "2026";

  const currentBox = document.getElementById("currentBox");
  const resultBox = document.getElementById("resultBox");
  const expectedBox = document.getElementById("expectedBox");

  const branchEl = document.getElementById("branch");
  const staffNameEl = document.getElementById("staffName");
  const pinEl = document.getElementById("pin");
  const codeEl = document.getElementById("code");

  function getUnclaimedPrize(){
    try{
      const raw = localStorage.getItem(prizeKey);
      return raw ? JSON.parse(raw) : null;
    }catch{ return null; }
  }
  function clearUnclaimedPrize(){
    localStorage.removeItem(prizeKey);
  }

  function addRedeemedLog(entry){
    let arr = [];
    try{
      const raw = localStorage.getItem(redeemedKey);
      arr = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(arr)) arr = [];
    }catch{ arr = []; }

    arr.unshift(entry);
    localStorage.setItem(redeemedKey, JSON.stringify(arr.slice(0, 50)));
  }

  function setResult(ok, html){
    resultBox.style.display = "block";
    resultBox.className = "pill " + (ok ? "ok" : "bad");
    resultBox.innerHTML = html;
  }

  function getQueryCode(){
    const params = new URLSearchParams(location.search);
    const c = params.get("code");
    return c ? String(c).trim().toUpperCase() : "";
  }

  function renderCurrent(){
    const v = getUnclaimedPrize();
    const q = getQueryCode();

    expectedBox.style.display = "none";
    expectedBox.innerHTML = "";

    if (!v){
      currentBox.className = "pill bad";
      currentBox.innerHTML =
        "No unclaimed prize on this device.<br>" +
        "<span class='muted'>If the customer shows a code, paste it above and (in the official version) we‚Äôd validate it centrally.</span>";
      if (q && !codeEl.value) codeEl.value = q;
      return;
    }

    currentBox.className = "pill ok";
    currentBox.innerHTML =
      `Current unclaimed prize on this device:<br>` +
      `Prize: <b>${v.prizeLabel}</b><br>` +
      `Code: <span class="mono">${v.code}</span><br>` +
      `<span class="muted">Score: ${v.score} ‚Ä¢ Created: ${new Date(v.createdAt).toLocaleString()}</span>`;

    // Prefill code field
    if (q) codeEl.value = q;
    else codeEl.value = v.code;

    expectedBox.style.display = "block";
    expectedBox.innerHTML = `Expected: <span class="mono">${String(v.code).toUpperCase()}</span>`;
  }

  document.getElementById("backBtn").onclick = () => {
    location.href = "./index.html";
  };

  document.getElementById("resetBtn").onclick = () => {
    const ok = confirm("Reset demo on this device?\nThis will clear the current unclaimed voucher and the redeemed log.");
    if (!ok) return;
    localStorage.removeItem(prizeKey);
    localStorage.removeItem(redeemedKey);
    setResult(true, "‚úÖ Demo reset completed on this device.");
    renderCurrent();
  };

  document.getElementById("redeemBtn").onclick = () => {
    const v = getUnclaimedPrize();
    const pin = String(pinEl.value || "").trim();
    const code = String(codeEl.value || "").trim().toUpperCase();
    const branch = String(branchEl.value || "").trim();
    const staffName = String(staffNameEl.value || "").trim();

    if (pin !== DEMO_PIN){
      setResult(false, "Invalid staff PIN.");
      return;
    }

    if (!code.startsWith("YMS-SAKURA-") || code.length < 12){
      setResult(false, "Invalid code format.");
      return;
    }

    if (!v){
      setResult(false, "No unclaimed prize stored on this device.");
      return;
    }

    if (code !== String(v.code).toUpperCase()){
      setResult(false,
        "This code does not match the current unclaimed voucher on this device.<br>" +
        "<span class='muted'>In the official version, this would be validated centrally across devices.</span>"
      );
      return;
    }

    // Redeem (demo)
    const entry = {
      code: v.code,
      prizeLabel: v.prizeLabel,
      score: v.score,
      branch,
      staffName: staffName || null,
      redeemedAt: new Date().toISOString()
    };

    addRedeemedLog(entry);
    clearUnclaimedPrize();

    setResult(true,
      `‚úÖ Redeemed successfully.<br>` +
      `Code: <span class="mono">${entry.code}</span><br>` +
      `Prize: <b>${entry.prizeLabel}</b><br>` +
      `Branch: <b>${entry.branch}</b><br>` +
      `${entry.staffName ? `Staff: <b>${entry.staffName}</b><br>` : ""}` +
      `<span class="muted">Redeemed: ${new Date(entry.redeemedAt).toLocaleString()}</span>`
    );

    renderCurrent();
  };

  renderCurrent();
})();
</script>
</body>
</html>
